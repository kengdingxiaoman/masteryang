## 概述
本文用来指导orca项目数据库的开发，规范中大部分使用于所有关系型数据库，一小部分只适用于mysql。

## 原则
- 解放数据库CPU，把业务逻辑计算放到服务层，数据库只做基本的读写
- 数据库擅长存储与索引，计算移到上层中去做

## 具体规范

## 基础规范
- 使用InnoDB存储引擎 (针对mysql数据库)<br/>
	支持事务、行级锁、并发性能更好、CPU及内存缓存页优化使得资源利用率更高
- 字符集使用utf8mb4<br/>
	utf8mb4是utf8的超集，支持emoji表情以及部分不可见汉字
- 数据库表，数据库字段必须都包含中文注释

- 禁止使用视图，存储过程，触发器<br/>
	业务逻辑放到代码中，数据库只做读写数据
- 禁止存储大文件，图片，大文件应存储到专门的文件服务器中

### 命名规范
- 库表，表名，字段名均使用小写，下划线风格，不超过32个字符，不允许使用拼音，特别是拼音首字母缩写

- 表名：t\_xxx， 唯一索引：uniq\_xxxx，非唯一索引：idx\_xxx
- 禁止使用数据库保留字

### Schema设计原则
- 核心表字段数量尽可能地少，有大字段要考虑拆分

- 适当考虑一些反范式的表设计，增加冗余字段，减少JOIN
- 资金字段考虑统一*100处理成整型，避免使用decimal浮点类型存储
- 日志类型的表可以考虑按创建时间水平切割，定期归档历史数据
- 单表行数超过500万行或者单表容量超过2GB，才推荐进行分库分表

### 表设计规范
- 单实例表数目不超过150张

- 单表字段不超过30个
- 表必须有主键，例如自增主键
	1. 主键递增，数据行写入可以提高插入性能，可以避免page分裂，减少表碎片提升空间和内存的使用
	2. 主键要选择较短的数据类型，InnoDB引擎普通索引都会保存主键的值，较短的数据类型可以有效的减少索引的磁盘空间，提高索引的缓存效率
- 禁止使用外键
- 每张表都需要包含create\_time，update\_time，version三个字段，用来记录数据创建时间，最后一次更新时间和版本号，版本号可用于乐观锁处理
- 主业务逻辑表使用自增的逻辑主键

### 字段设计规范
- 必须把字段定义为NOT NULL，并且提供默认值
	1. null 的列使索引/索引统计/值比较都更加复杂，对MySQL来说更难优化
	2. null 这种类型MySQL内部需要进行特殊处理，增加数据库处理记录的复杂性；同等条件下，表中有较多空字段的时候，数据库的处理性能会降低很多
	3. null 值需要更多的存储空，无论是表还是索引中每行中的null的列都需要额外的空间来标识
	4. 对 null 的处理时候，只能采用is null或is not null，而不能采用=、in、\<、\<\>、!=、not in这些操作符号。<br/>
	如：where name != 'orca'，如果存在name为null值的记录，查询结果就不会包含name为null值的记录
- 禁止使用TEXT，BLOB类型

- 禁止使用小数存储货币
- 存储手机号使用varchar(20)
- 禁止使用ENUM，可使用TINYINT代替
- 小数类型为 decimal，禁止使用 float 和 double

### 索引设计规范
- 单表索引控制在5个

- 单索引字段数不允许超过5个
- 禁止在更新十分频繁的属性上建立索引<br/>
	更新会变更B+树，更新频繁的字段建立索引会大大降低数据库性能
- 禁止在区分度不高的属性上建立索引<br/>
	“性别”这种区分度不大的属性，建立索引是没有什么意义的，不能有效过滤数据，性能与全表扫描类似
- 建立组合索引时，必须把区分度高的字段放在前面

### SQL使用规范
- 禁止使用 select \* ，只获取必要的字段

- 禁止使用 INSERT INTO t\_xxx VALUES(xxx)，必须显示指定插入的列属性
- 禁止使用属性隐式转换<br/>
  SELECT user_id FROM t_user WHERE user_phone = 13812345678 会导致全表扫描，而不能命中user_phone索引<br/>
	正确的写法是：SELECT user_id FROM t_user WHERE user_phone = \'13812345678\'
- 禁止在WHERE条件的属性上使用函数或者表达式<br/>
  SELECT user_id FROM t_user WHERE from_unixtime(day)>='2017-03-25' 会导致全表扫描<br/>
  正确的写法是：SELECT user_id FROM t_user WHERE day>= unix_timestamp('2017-03-25 00:00:00')
- 禁止负向查询，以及%开头的模糊查询，针对的是仅用一个查询条件或者使用该字段认为可以用到索引的
  1. 负向查询条件：NOT、!=、<>、!<、!>、NOT IN、NOT LIKE等，会导致全表扫描
  2. %开头的模糊查询，会导致全表扫描
- 禁止大表使用JOIN查询，禁止大表使用子查询
- 禁止超过3张表以上的JOIN
- 禁止使用OR条件，必须改为IN查询
- 应用程序连接数据库，禁止使用root用户进行连接
